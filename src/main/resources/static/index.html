<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Barbearia Java | Agendamento</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .selected-card { @apply ring-2 ring-blue-600 border-blue-600 bg-blue-50; }
        .time-slot-active { @apply bg-slate-900 text-white border-slate-900 shadow-lg scale-105; }
        /* Estilo para horário ocupado */
        .time-slot-busy { @apply bg-slate-100 text-slate-300 border-slate-100 cursor-not-allowed decoration-slice line-through; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 antialiased pb-24 lg:pb-12">

<!-- Navegação Superior -->
<nav class="sticky top-0 z-50 w-full bg-white/80 backdrop-blur-md border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
        <div class="flex items-center gap-2">
            <i data-lucide="scissors" class="text-blue-600 w-6 h-6"></i>
            <span class="text-xl font-bold tracking-tight">Barbearia Java</span>
        </div>

        <!-- Área do Utilizador -->
        <div class="flex items-center gap-4">
            <a href="barbeiro.html" class="hidden md:block text-xs font-medium text-slate-400 hover:text-blue-600 transition-colors mr-2">
                Painel Admin
            </a>
            <div class="flex items-center gap-3 pl-4 border-l border-slate-200">
                <div class="text-right hidden sm:block">
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Olá,</p>
                    <p id="nomeUsuario" class="text-sm font-bold text-slate-900 leading-none">Visitante</p>
                </div>
                <button onclick="logout()" class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all" title="Sair">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </div>
</nav>

<main class="max-w-6xl mx-auto px-4 py-8">
    <div class="lg:grid lg:grid-cols-12 lg:gap-12">

        <!-- Coluna de Seleção (Esquerda) -->
        <div class="lg:col-span-8 space-y-10">

            <!-- 1. Seleção de Barbeiro -->
            <section>
                <div class="flex items-center gap-3 mb-6">
                    <span class="flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-600 font-bold text-sm">1</span>
                    <h2 class="text-xl font-bold text-slate-800">Escolha o Profissional</h2>
                </div>
                <div id="listaBarbeiros" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="col-span-full py-10 text-center text-slate-400">
                        <div class="animate-spin inline-block w-6 h-6 border-2 border-current border-t-transparent rounded-full mb-2"></div>
                        <p>A procurar equipa...</p>
                    </div>
                </div>
            </section>

            <!-- 2. Seleção de Serviço -->
            <section>
                <div class="flex items-center gap-3 mb-6">
                    <span class="flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-600 font-bold text-sm">2</span>
                    <h2 class="text-xl font-bold text-slate-800">Selecione o Serviço</h2>
                </div>
                <div id="listaServicos" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <!-- Serviços carregados aqui -->
                </div>
            </section>

            <!-- 3. Data e Hora -->
            <section>
                <div class="flex items-center gap-3 mb-6">
                    <span class="flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-600 font-bold text-sm">3</span>
                    <h2 class="text-xl font-bold text-slate-800">Data e Horário</h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Selecione o dia</label>
                        <input type="date" id="inputData"
                               class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all font-medium">
                        <p id="avisoDomingo" class="mt-3 text-sm text-red-500 hidden flex items-center gap-2">
                            <i data-lucide="info" class="w-4 h-4"></i> Estamos fechados aos domingos.
                        </p>
                    </div>

                    <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm relative">
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Horários disponíveis</label>

                        <!-- Loading Overlay para horários -->
                        <div id="loadingHorarios" class="hidden absolute inset-0 bg-white/80 z-10 flex items-center justify-center rounded-2xl">
                            <div class="animate-spin w-5 h-5 border-2 border-blue-600 border-t-transparent rounded-full"></div>
                        </div>

                        <div id="containerHorarios" class="grid grid-cols-3 gap-2 max-h-[180px] overflow-y-auto pr-2 no-scrollbar">
                            <p class="col-span-3 text-center py-10 text-slate-400 text-sm italic">Escolha Barbeiro e Data primeiro</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Coluna de Resumo (Desktop Sticky) -->
        <div class="hidden lg:block lg:col-span-4">
            <div class="sticky top-28 bg-white rounded-2xl border border-slate-200 p-8 shadow-xl">
                <h3 class="text-lg font-bold text-slate-900 mb-6">Resumo do Agendamento</h3>

                <div class="space-y-4 mb-8">
                    <div class="flex justify-between items-center py-2 border-b border-slate-100">
                        <span class="text-slate-500 text-sm">Barbeiro</span>
                        <span id="resumoBarbeiro" class="font-bold text-slate-900">-</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-slate-100">
                        <span class="text-slate-500 text-sm">Serviço</span>
                        <span id="resumoServico" class="font-bold text-slate-900">-</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-slate-100">
                        <span class="text-slate-500 text-sm">Data/Hora</span>
                        <span id="resumoData" class="font-bold text-slate-900 text-right">-</span>
                    </div>
                </div>

                <div id="errorBoxDesktop" class="hidden mb-6 p-4 bg-red-50 border border-red-100 rounded-xl flex items-start gap-3 text-red-600">
                    <i data-lucide="alert-circle" class="w-5 h-5 shrink-0"></i>
                    <span id="errorMsgDesktop" class="text-xs font-semibold"></span>
                </div>

                <div class="flex justify-between items-baseline mb-8">
                    <span class="text-slate-500">Valor Total</span>
                    <span id="resumoTotal" class="text-3xl font-black text-blue-600">R$ 0,00</span>
                </div>

                <button id="btnConfirmarDesktop" disabled
                        class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold text-lg hover:bg-slate-800 transition-all active:scale-[0.97] disabled:bg-slate-200 disabled:cursor-not-allowed shadow-lg shadow-slate-200">
                    Confirmar Agora
                </button>
            </div>
        </div>
    </div>
</main>

<!-- Rodapé Mobile (Sticky) -->
<div class="lg:hidden fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-slate-200 p-4 px-6 shadow-[0_-10px_30px_rgba(0,0,0,0.08)] z-50">
    <div id="errorBoxMobile" class="hidden mb-3 p-3 bg-red-600 text-white rounded-xl flex items-center gap-2 text-xs font-bold">
        <i data-lucide="alert-circle" class="w-4 h-4"></i>
        <span id="errorMsgMobile"></span>
    </div>

    <div class="flex items-center justify-between gap-6 max-w-md mx-auto">
        <div class="flex flex-col">
            <span class="text-[10px] text-slate-400 uppercase font-black tracking-widest">Total</span>
            <span id="mobileTotal" class="text-2xl font-black text-slate-900">R$ 0,00</span>
        </div>
        <button id="btnConfirmarMobile" disabled
                class="flex-1 bg-slate-900 text-white py-4 rounded-xl font-bold text-base active:scale-[0.95] transition-all disabled:bg-slate-200 shadow-xl shadow-slate-200">
            Agendar
        </button>
    </div>
</div>

<!-- Modal de Sucesso -->
<div id="modalSucesso" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-6 bg-slate-900/80 backdrop-blur-md">
    <div class="bg-white rounded-[2rem] p-10 max-w-sm w-full text-center shadow-2xl">
        <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6">
            <i data-lucide="check" class="w-10 h-10"></i>
        </div>
        <h2 class="text-2xl font-black text-slate-900 mb-2">Sucesso!</h2>
        <p class="text-slate-500 mb-8 leading-relaxed">O teu horário foi reservado. Receberás uma confirmação em breve.</p>
        <button onclick="location.reload()" class="w-full py-4 bg-slate-900 text-white font-bold rounded-2xl hover:bg-slate-800 transition-colors shadow-lg">
            Fazer Novo Agendamento
        </button>
    </div>
</div>

<script>
    // VERIFICAÇÃO DE LOGIN E RECUPERAÇÃO DE DADOS
    const usuarioLogado = JSON.parse(localStorage.getItem('usuario_logado'));

    // Se não houver usuário, redireciona para login
    if (!usuarioLogado) {
        window.location.href = 'login.html';
    } else {
        // Atualiza UI com nome do usuário
        document.addEventListener("DOMContentLoaded", () => {
            const nomeEl = document.getElementById('nomeUsuario');
            if (nomeEl) nomeEl.textContent = usuarioLogado.nome.split(' ')[0];
        });
    }

    function logout() {
        localStorage.removeItem('usuario_logado');
        window.location.href = 'login.html';
    }

    const API_URL = 'http://localhost:8080/api';

    // Estado Global atualizado com ID do cliente logado
    const state = {
        servico: null,
        data: null,
        horario: null,
        barbeiro: null,
        cliente: usuarioLogado ? usuarioLogado.id : null, // ID dinâmico
        ocupados: []
    };

    lucide.createIcons();

    document.addEventListener("DOMContentLoaded", () => {
        carregarBarbeiros();
        carregarServicos();
        configurarCalendario();
    });

    function carregarBarbeiros() {
        fetch(`${API_URL}/barbeiros`)
            .then(res => res.ok ? res.json() : Promise.reject())
            .then(renderizarBarbeiros)
            .catch(() => renderizarBarbeiros([{ id: 1, nome: "Beatriz Lima" }, { id: 2, nome: "Leandro Lima" }]));
    }

    function renderizarBarbeiros(barbeiros) {
        const container = document.getElementById('listaBarbeiros');
        container.innerHTML = '';
        barbeiros.forEach(barb => {
            const fotoUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(barb.nome)}&background=f1f5f9&color=2563eb&bold=true&size=128`;
            const card = document.createElement('div');
            card.className = "group flex items-center gap-4 p-4 bg-white rounded-2xl border-2 border-slate-100 cursor-pointer transition-all hover:border-blue-200 hover:shadow-md";
            card.innerHTML = `<img src="${fotoUrl}" class="w-14 h-14 rounded-full border-2 border-white shadow-sm" alt="${barb.nome}">
                <div class="flex-grow"><h4 class="font-bold text-slate-800 group-hover:text-blue-600 transition-colors">${barb.nome}</h4>
                <p class="text-[11px] text-slate-400 font-bold uppercase tracking-tighter">Profissional Disponível</p></div>`;
            card.onclick = () => {
                document.querySelectorAll('#listaBarbeiros > div').forEach(el => el.classList.remove('ring-2', 'ring-blue-600', 'border-blue-600', 'bg-blue-50'));
                card.classList.add('ring-2', 'ring-blue-600', 'border-blue-600', 'bg-blue-50');
                state.barbeiro = barb;
                esconderErro();
                atualizarHorariosOcupados(); // Busca agenda ao selecionar barbeiro
                atualizarInterface();
            };
            container.appendChild(card);
        });
        lucide.createIcons();
    }

    function carregarServicos() {
        fetch(`${API_URL}/servicos`)
            .then(res => res.ok ? res.json() : Promise.reject())
            .then(renderizarServicos)
            .catch(() => renderizarServicos([
                { id: 1, nome: "Corte Social", preco: 35.0, duracaoMinutos: 30 },
                { id: 2, nome: "Barba", preco: 25.0, duracaoMinutos: 20 }
            ]));
    }

    function renderizarServicos(servicos) {
        const container = document.getElementById('listaServicos');
        container.innerHTML = '';
        servicos.forEach(serv => {
            const card = document.createElement('div');
            card.className = "group p-5 bg-white rounded-2xl border-2 border-slate-100 cursor-pointer transition-all hover:border-blue-200 hover:shadow-md";
            card.innerHTML = `<div class="flex justify-between items-start mb-2"><h4 class="font-bold text-slate-800 group-hover:text-blue-600 transition-colors">${serv.nome}</h4>
                <span class="text-sm font-black text-blue-600">R$ ${serv.preco.toFixed(2)}</span></div>
                <div class="flex items-center gap-2 text-slate-400 text-xs font-medium"><i data-lucide="timer" class="w-3 h-3"></i> ${serv.duracaoMinutos} min</div>`;
            card.onclick = () => {
                document.querySelectorAll('#listaServicos > div').forEach(el => el.classList.remove('ring-2', 'ring-blue-600', 'border-blue-600', 'bg-blue-50'));
                card.classList.add('ring-2', 'ring-blue-600', 'border-blue-600', 'bg-blue-50');
                state.servico = serv;
                esconderErro();
                atualizarInterface();
            };
            container.appendChild(card);
        });
        lucide.createIcons();
    }

    function configurarCalendario() {
        const input = document.getElementById('inputData');
        input.min = new Date().toISOString().split('T')[0];
        input.addEventListener('change', (e) => {
            const date = new Date(e.target.value + 'T00:00:00');
            if(date.getDay() === 0) {
                document.getElementById('avisoDomingo').classList.remove('hidden');
                state.data = null;
                document.getElementById('containerHorarios').innerHTML = '<p class="col-span-3 text-center py-10 text-red-400 text-xs font-bold uppercase">Domingos estamos fechados</p>';
            } else {
                document.getElementById('avisoDomingo').classList.add('hidden');
                state.data = e.target.value;
                atualizarHorariosOcupados(); // Busca agenda ao mudar data
            }
            esconderErro();
            atualizarInterface();
        });
    }

    // Busca agendamentos do barbeiro para o dia selecionado
    async function atualizarHorariosOcupados() {
        if (!state.barbeiro || !state.data) {
            gerarSlotsHorarios();
            return;
        }

        document.getElementById('loadingHorarios').classList.remove('hidden');

        try {
            const response = await fetch(`${API_URL}/agendamentos/barbeiro/${state.barbeiro.id}`);
            const agendamentos = await response.json();

            state.ocupados = agendamentos
                .filter(a => a.status !== 'CANCELADO' && a.dataHoraInicio.startsWith(state.data))
                .map(a => {
                    const inicio = new Date(a.dataHoraInicio);
                    const fim = new Date(a.dataHoraFim);
                    return {
                        inicio: inicio.getHours() * 60 + inicio.getMinutes(),
                        fim: fim.getHours() * 60 + fim.getMinutes()
                    };
                });

        } catch (err) {
            console.error("Erro ao buscar agenda:", err);
            state.ocupados = [];
        } finally {
            document.getElementById('loadingHorarios').classList.add('hidden');
            gerarSlotsHorarios();
        }
    }

    function gerarSlotsHorarios() {
        const container = document.getElementById('containerHorarios');
        container.innerHTML = '';

        if (!state.data || !state.barbeiro) {
            container.innerHTML = '<p class="col-span-3 text-center py-10 text-slate-400 text-sm italic">Selecione Profissional e Data</p>';
            return;
        }

        state.horario = null;

        for(let h=9; h<19; h++) {
            ['00', '30'].forEach(min => {
                const horaStr = `${String(h).padStart(2,'0')}:${min}`;
                const slotMinutos = h * 60 + parseInt(min);
                const isOcupado = state.ocupados.some(intervalo =>
                    slotMinutos >= intervalo.inicio && slotMinutos < intervalo.fim
                );

                const btn = document.createElement('div');

                if (isOcupado) {
                    btn.className = "p-3 text-center text-sm font-bold border-2 border-slate-50 rounded-xl time-slot-busy";
                    btn.textContent = horaStr;
                    btn.title = "Horário indisponível";
                } else {
                    btn.className = "p-3 text-center text-sm font-bold border-2 border-slate-50 rounded-xl cursor-pointer transition-all hover:bg-slate-100";
                    btn.textContent = horaStr;
                    btn.onclick = () => {
                        document.querySelectorAll('.time-slot-active').forEach(el => el.classList.remove('time-slot-active', 'bg-slate-900', 'text-white', 'border-slate-900', 'shadow-lg', 'scale-105'));
                        btn.classList.add('time-slot-active', 'bg-slate-900', 'text-white', 'border-slate-900', 'shadow-lg', 'scale-105');
                        state.horario = horaStr;
                        esconderErro();
                        atualizarInterface();
                    };
                }
                container.appendChild(btn);
            });
        }
    }

    function atualizarInterface() {
        const preco = state.servico ? `R$ ${state.servico.preco.toFixed(2)}` : 'R$ 0,00';
        document.getElementById('resumoBarbeiro').textContent = state.barbeiro ? state.barbeiro.nome : '-';
        document.getElementById('resumoServico').textContent = state.servico ? state.servico.nome : '-';
        document.getElementById('resumoData').textContent = (state.data && state.horario) ? `${state.data.split('-').reverse().join('/')} às ${state.horario}` : '-';
        document.getElementById('resumoTotal').textContent = preco;
        document.getElementById('mobileTotal').textContent = preco;

        const pronto = state.barbeiro && state.servico && state.data && state.horario;
        document.getElementById('btnConfirmarDesktop').disabled = !pronto;
        document.getElementById('btnConfirmarMobile').disabled = !pronto;
    }

    function mostrarErro(msg) {
        document.getElementById('errorMsgDesktop').textContent = msg;
        document.getElementById('errorBoxDesktop').classList.remove('hidden');
        document.getElementById('errorMsgMobile').textContent = msg;
        document.getElementById('errorBoxMobile').classList.remove('hidden');
        lucide.createIcons();
    }

    function esconderErro() {
        document.getElementById('errorBoxDesktop').classList.add('hidden');
        document.getElementById('errorBoxMobile').classList.add('hidden');
    }

    async function finalizarAgendamento() {
        const btns = [document.getElementById('btnConfirmarDesktop'), document.getElementById('btnConfirmarMobile')];
        btns.forEach(b => b.disabled = true);
        esconderErro();

        const payload = {
            clienteId: state.cliente,
            barbeiroId: state.barbeiro.id,
            servicoId: state.servico.id,
            dataHora: `${state.data}T${state.horario}:00`
        };

        try {
            const response = await fetch(`${API_URL}/agendamentos`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            if(!response.ok) {
                const msgErro = await response.text();
                throw new Error(msgErro);
            }

            document.getElementById('modalSucesso').classList.remove('hidden');
        } catch (err) {
            mostrarErro(err.message);
            btns.forEach(b => b.disabled = false);
        }
    }

    document.getElementById('btnConfirmarDesktop').onclick = finalizarAgendamento;
    document.getElementById('btnConfirmarMobile').onclick = finalizarAgendamento;
</script>
</body>
</html>